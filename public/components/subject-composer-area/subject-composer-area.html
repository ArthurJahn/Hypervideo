<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../components/hypervideo-node/hypervideo-node.html">

<dom-module id="subject-composer-area">
  <style is="custom-style">
  #backcanvas {
    position: absolute;
    top: 75px;
    bottom: 10px;
    left: 10px;
    right: 10px;
  }
  #backcanvas canvas{
    width: 100%;
    height: 100%;
    background-color:rgba(220,220,220,0.2);/*var(--light-divider-color);*/
  }
  #toucharea {
    position: absolute;
    top: 100px;
    bottom: 35px;
    left: 35px;
    right: 35px;
    background-color:rgba(220,220,220,0.1);/*var(--light-divider-color);*/
    overflow: hidden;
  }
  #hint-text {
    width: 360px;
    position: absolute;
    top: 45%;
    left: 50%;
    margin: -160px -180px;
    padding: 160px 0;
    border-radius: 50%;
    background-color:rgba(220,220,220,0.2);/*var(--light-divider-color);*/
    color: rgba(200,200,200,1);/*var(--light-divider-color);*/
    text-align: center;
    font-size: 22px;
    font-weight: bold;
  }
  </style>
  <template>
    <paper-input id="subjectName"
    name="name"
    label="Nome do Curso"
    on-change="_updateSubject">
    </paper-input>
    <div id="backcanvas">
      <canvas></canvas>
    </div>
    <div id="toucharea"
    on-tap="composerTap">
      <template is="dom-if" if="{{firstTouch}}">
        <div id="hint-text">Clique para adicionar um hypervideo</div>
      </template>
    </div>
    <!-- this is where hypervideos will be displayed -->
  </template>

  <script>
    Polymer({
      is: 'subject-composer-area',
      composerTap: function(e) {
        this._updateSubject(e);
        this._createHypervideo(e);
        this.firstTouch = !(this._subject.hypervideos.length>0);
      },
      ready: function() {
        this.firstTouch = true;
        this._subject = null;
        this.hypervideos = new Array();
      },
      properties: {
        linking: {
          type: String,
          value: null,
          notify: true,
          observer: "linkingChanged"
        }
      },
      linkingChanged: function (newLinking) {
        var length = (this.hypervideos) ? this.hypervideos.length : 0;
        for(var i=0; i<length; i++) {
          var hypervideo = this.hypervideos[i];
          hypervideo.linking = newLinking;
        }
      },
      _createHypervideo: function(e) {
        var self = this;
        var xOffset = 35; //depends on initial definition in toucharea css
        var yOffset = 100;//depends on initial definition in toucharea css
        // defines bounds and offset of dragging limits for a hypervideoNode
        var rect = self.$.toucharea.getBoundingClientRect();
        var bounds = {width: rect.right - rect.left,
                      height: rect.bottom - rect.top,
                      x: rect.left-xOffset,
                      y: rect.top-yOffset}
        console.log("a: " + xOffset);
        var touchX = e.detail.x - bounds.x;
        var touchY = e.detail.y - bounds.y;
        var subjectId = self._subject._id;
        var options = {
          x : touchX,
          y : touchY,
          bounds: bounds,
          subjectId: subjectId,
          linking: this.linking 
        }
        var hypervideoNode = new HypervideoNode(options);

        hypervideoNode.addEventListener("linking-changed", function(ev){
          // inside event listener methods, the target object
          // is the reference for 'this'
          var hnInstance = this;
          self.linking = hnInstance.linking;
          if(self.linking) {
            if(!self._firstId) {
              self._firstId = self.linking;
            } else {
              self._createLink(self._firstId, self.linking);
            }
          } else {
            self._firstId = self.linking;
          }
        });
        self.appendChild(hypervideoNode);
        //FIX-ME : Verify use of querySelectorAll and remove this array
        self.hypervideos.push(hypervideoNode);
        self._subject.addHypervideo(hypervideoNode.id);
      },
      _updateSubject: function(e) {
        if(this._subject === null) {
          this.fire('subject-created');
        }
        if(this._subject) {
          if(this.$.subjectName.value === "") {
            this.$.subjectName.value = this._subject.name;
          } else if (this.$.subjectName.value !== this._subject.name) {
            this._subject.setName(this.$.subjectName.value);
            this.fire('subject-changed');
          }
        }
      },
      _createLink: function(firstId, secondId) {
        var canCreate = true;
        if(firstId !== secondId) {
          var connection = {first: firstId, second: secondId};
          if(this._subject.addConnection(connection)){
            this.linking = null;
            this._firstId= null;
          }
        }
        console.log(this._subject);
      },
    });
  </script>
</dom-module>
