//Polymer web component capable of creating and editing the content of an
// hypervideo.

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="hypervideo-node">
  <style is="custom-style">
  #wrapper {
    position: absolute;
    max-height: 50px;
  }
  #icon {
    position: absolute;
    max-width: 50px;
    max-height: 50px;
    padding: 25px 23px;
    line-height: 10px;
    border-radius: 50%;
    background-color:#DCDCDC;/*var(--light-divider-color);*/
    color: #212121;/*var(--light-divider-color);*/
    text-align: center;
    font-size: 19px;
    font-weight: bold;
    cursor: pointer;
    z-index: 1;
  }
  #connect {
    position: absolute;
    left:3px;
    top:-1px;
    max-width: 96px;
    max-height: 16px;
    padding: 3px 4px 4px 4px;
    line-height: 10px;
    border-radius: 50%;
    background-color:#FFC107;/*var(--accent-color);*/
    color: #FFC107;/*var(--accent-color);*/
    text-align: center;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    z-index: 2;
  }
  #delete {
    position: absolute;
    left:-7px;
    top:14px;
    max-width: 96px;
    max-height: 16px;
    padding: 3px 5.5px 4px 5.5px;
    line-height: 10px;
    border-radius: 50%;
    background-color:#D23216;/*var(--sec-accent-color);*/
    color: #D23216;/*var(--sec-accent-color);*/
    text-align: center;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    z-index: 2;
  }
  #edit {
    position: absolute;
    left:21px;
    top:-6px;
    max-width: 96px;
    max-height: 16px;
    padding: 3px 5px 4px 5px;
    line-height: 10px;
    border-radius: 50%;
    background-color: #12AE28;/*var(--trd-accent-color);*/
    color: #12AE28;/*var(--trd-accent-color);*/
    text-align: center;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    z-index: 2;
  }
  #subvideos {
    position: absolute;
    left:25px;
    top:25px;
    width: 120px;
    height: 70px;
    background: #212121;
    display: none;
    z-index: 0;
  }
  </style>
  <template>
    <div id="wrapper"
    class="animated fadeIn"
    on-mouseover="_onHover"
    on-mouseout="_onHout">
      <div id="subvideos"></div>

      <div id="icon"
      on-tap="_onIconTap"
      on-track="_onIconTrack">H</div>

      <div id="connect"
      class="animated fadeIn"
      on-tap="_onConnectTap">+</div>

      <div id="delete"
      class="animated fadeIn"
      on-tap="_onDeleteTap">x</div>

      <div id="edit"
      class="animated fadeIn"
      on-tap="_onEditTap">e</div>
    </div>
  </template>
  <script>
    HypervideoNode = Polymer({
      is: 'hypervideo-node',
      //tag properties
      properties: {
        connectId: {
          type: String,
          notify: true,
          observer: "handleConnectId"
        },
        deleting: {
          type: Boolean,
          notify: true,
        },
        dragging: {
          type: Boolean,
          notify: true,
        }
      },
      // Polymer factory implementation
      factoryImpl: function(options) {
        this._bounds = options.bounds;
        this._x = options.x;
        this._y = options.y;
        this._hypervideo = null;
        this._subjectId = options.subjectId;
        this.connectId = options.connectId;
      },
      // fired when element is attached to DOM
      // used to get element properties like bounds
      // and position relative to document
      attached: function() {
        Polymer.dom.flush();
        this._w = this.$.icon.clientWidth;
        this._x -= this._w/2;
        this._y -= this._w/2;
        this.$.wrapper.style.left = this._x+"px";
        this.$.wrapper.style.top = this._y+"px";
        // event fired so that Meteor can handle the creation
        // and persistence of a new instance of hypervideo
        this.fire('hypervideo-created');
        this.id = "_"+this._hypervideo._id;
        this.hypervideoId = this._hypervideo._id;
        console.log(this.id);
      },
//=============== Public Methods =================//
      handleConnectId: function() {
        if(this.connectId) {
          this.$.icon.style.background = "#FFC107";
        }
        else {
          this.$.icon.style.background = "#DCDCDC";
        }
      },
      getPos(){
        return {
          x: this._x,
          y: this._y,
        };
      },
//=============== Private Methods ================//
      // handle taping
      _onIconTap: function(e) {
        if(this.connectId) {
          this._onConnectTap(e);
        } else {
          this._showPreview();
        }
      },
      // handle tracking
      _onIconTrack: function(e) {
        switch (e.detail.state) {
          case 'start':
            this._iconTrackStart(e);
            break;
          case 'track':
            this._iconTrackXY(e);
            break;
          case 'end':
            this._iconTrackEnd();
            break;
        }
      },
      _iconTrackStart: function(e) {
        this.$.icon.style.cursor = "move";
        this.dragging = true;
      },
      _iconTrackXY: function(e) {
        var ddx = e.detail.ddx || 0;
        var ddy = e.detail.ddy || 0;
        this._x+= ddx;
        this._y+= ddy;

        this._x = (this._x > this._bounds.width)?this._bounds.width : this._x;
        this._x = (this._x < 20)?20 : this._x;
        this._y = (this._y > this._bounds.height+this._bounds.y)?this._bounds.height+this._bounds.y : this._y;
        this._y = (this._y < this._bounds.y + 20)?this._bounds.y + 20 : this._y;

        this.$.wrapper.style.left = this._x+"px";
        this.$.wrapper.style.top = this._y+"px";
      },
      _iconTrackEnd: function() {
        this._hypervideo.x = this._x;
        this._hypervideo.y = this._y;
        this.$.icon.style.cursor = "pointer";
        this.dragging = false;
        this.fire('hypervideo-changed');
      },
      // handle hovering
      _onHover: function(e) {
        this.$.delete.style.display = "block";
        this.$.connect.style.display = "block";
        this.$.edit.style.display = "block";
        if(e.target.id !== "icon") {
          e.target.style.color = "#FFF";
        }
      },
      _onHout: function(e) {
        this.$.delete.style.display = "none";
        this.$.connect.style.display = "none";
        this.$.edit.style.display = "none";
        if(e.target.id !== "icon") {
          e.target.style.color = e.target.style.backgroundColor;
        }
      },
      // Toggle connect mode
      _onConnectTap: function(e) {
        if(this.connectId && this.connectId === this.hypervideoId){
            console.log(this.connectId);
            console.log(this.hypervideoId);
            this.connectId = null;
        } else {
          console.log(this.hypervideoId);
          console.log(this.connectId);
          this.connectId = this.hypervideoId;
        }
        this.handleConnectId();
      },
      // Delete Node
      _onDeleteTap: function(e) {
        if(!this.deleting) {
          this.fire('hypervideo-deleted');
          this.deleting = true;
        }
      },
      _onEditTap: function(e) {
        this.parentNode.toggle(this);
      },
      _showPreview: function() {
        if(this.$.subvideos.style.display !== "block") {
          this.$.subvideos.style.display = "block";
        }
        else {
          this.$.subvideos.style.display = "none";
        }
      }
    });
  </script>
</dom-module>
